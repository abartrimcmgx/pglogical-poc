custom_pg_replication:
  query: |
    SELECT
      CASE WHEN NOT pg_is_in_recovery()
        THEN 0
        ELSE GREATEST (0, EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp()))) END AS lag
  master: true
  metrics:
    - lag:
        usage: "GAUGE"
        description: "Replication lag behind master in seconds"

custom_pg_stat_activity:
  query: |
    SELECT
      pid,
      usename,
      backend_start,
      wait_event_type,
      wait_event,
      backend_type
    FROM pg_stat_activity
  metrics:
    - pid:
        usage: "LABEL"
        description: "PID of the activity"
    - usename:
        usage: "LABEL"
        description: "Username of the activity"
    - backend_start:
        usage: "LABEL"
        description: "Start time of the activity"
    - wait_event_type:
        usage: "LABEL"
        description: "Wait event type of the activity"
    - wait_event:
        usage: "LABEL"
        description: "Wait event of the activity"
    - backend_type:
        usage: "LABEL"
        description: "Backend type of the activity"

custom_pg_replication_slot:
  query: |
    SELECT
      slot_name,
      slot_type,
      active,
      confirmed_flush_lsn
    FROM pg_replication_slots
  metrics:
    - slot_name:
        usage: "LABEL"
        description: "Name of the replication slot"
    - slot_type:
        usage: "LABEL"
        description: "Type of the replication slot"
    - active:
        usage: "COUNTER"
        description: "Active flag of the replication slot"
    - confirmed_flush_lsn:
        usage: "LABEL"
        description: "Confirmed flush LSN"

custom_pg_stat_replication:
  query: |
    SELECT
      application_name,
      client_addr,
      backend_start,
      state,
      sent_lsn,
      write_lsn,
      flush_lsn,
      replay_lsn,
      pg_current_wal_insert_lsn() AS insert_lsn,
      sync_state,
      pg_current_wal_insert_lsn() - replay_lsn::pg_lsn AS diff
    FROM pg_stat_replication
  metrics:
    - application_name:
        usage: "LABEL"
        description: "Name of replication"
    - client_addr:
        usage: "LABEL"
        description: "Target address of replication"
    - backend_start:
        usage: "LABEL"
        description: "Start time of replication"
    - state:
        usage: "LABEL"
        description: "State of replication"
    - sent_lsn:
        usage: "LABEL"
        description: "Sent LSN of replication"
    - write_lsn:
        usage: "LABEL"
        description: "Write LSN of replication"
    - flush_lsn:
        usage: "LABEL"
        description: "Flush LSN of replication"
    - replay_lsn:
        usage: "LABEL"
        description: "Replay LSN of replication"
    - insert_lsn:
        usage: "LABEL"
        description: "Current WAL insert LSN"
    - sync_state:
        usage: "LABEL"
        description: "Sync state of replication"
    - diff:
        usage: "COUNTER"
        description: "Lag of replication in bytes"
